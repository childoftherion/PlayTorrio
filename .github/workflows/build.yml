name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Setup Windows Players
        run: |
          if (Test-Path "mpv.rar") { 7z x mpv.rar -y }
          if (Test-Path "mpv.js-master-updated.rar") { 7z x mpv.js-master-updated.rar -y }
          if (Test-Path "vlc.rar") { 7z x vlc.rar -y }

          if (Test-Path "yt.zip") {
            7z x yt.zip -y
            Remove-Item yt.zip -Force
          } elseif (Test-Path "yt.rar") {
            7z x yt.rar -y
            Remove-Item yt.rar -Force
          }

          # FLATTEN yt/yt -> yt
          if (Test-Path "yt\yt\yt-dlp.exe") {
            Move-Item yt\yt\yt-dlp.exe yt\yt-dlp.exe -Force
            Remove-Item yt\yt -Recurse -Force
          }

      - name: Check yt-dlp (Windows)
        run: |
          if (Test-Path "yt\yt-dlp.exe") {
            Write-Host "✓ yt-dlp found"
          } else {
            Write-Error "❌ yt-dlp not found"
            exit 1
          }

      - run: npm run build -- --win --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Extract yt-dlp (Linux)
        run: |
          if [ -f linyt.zip ]; then
            unzip -q linyt.zip
            rm -f linyt.zip
          elif [ -f linyt.rar ]; then
            sudo apt-get update -y
            sudo apt-get install -y unar
            unar -o . linyt.rar
            rm -f linyt.rar
          fi

          # FLATTEN linyt/linyt -> linyt
          if [ -f linyt/linyt/yt-dlp_linux ]; then
            mv linyt/linyt/yt-dlp_linux linyt/yt-dlp_linux
            chmod +x linyt/yt-dlp_linux
            rm -rf linyt/linyt
          fi

      - name: Check yt-dlp (Linux)
        run: |
          if [ -f linyt/yt-dlp_linux ] || [ -f linyt/yt-dlp ]; then
            chmod +x linyt/yt-dlp* || true
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - run: npm run build -- --linux --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-macos-x64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          # FLATTEN macyt/macyt -> macyt
          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS x64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - run: npm run build -- --mac --x64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS arm64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - run: npm run build -- --mac --arm64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
  finalize-release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-linux
      - build-macos-x64
      - build-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: ver
        run: echo "version=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT

      - name: Ensure tag uses v prefix
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          echo "Using tag: $TAG"

      - name: Update GitHub Release (title + notes, keep draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          generate_release_notes: true
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
