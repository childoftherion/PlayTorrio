name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Setup Windows Players
        run: |
          if (Test-Path "yt.zip") {
            7z x yt.zip -y
            Remove-Item yt.zip -Force
          } elseif (Test-Path "yt.rar") {
            7z x yt.rar -y
            Remove-Item yt.rar -Force
          }

          # FLATTEN yt/yt -> yt
          if (Test-Path "yt\yt\yt-dlp.exe") {
            Move-Item yt\yt\yt-dlp.exe yt\yt-dlp.exe -Force
            Remove-Item yt\yt -Recurse -Force
          }

      - name: Check yt-dlp (Windows)
        run: |
          if (Test-Path "yt\yt-dlp.exe") {
            Write-Host "✓ yt-dlp found"
          } else {
            Write-Error "❌ yt-dlp not found"
            exit 1
          }

      - name: Setup PlayTorrioPlayer (Windows)
        run: |
          # Remove existing PlayTorrioPlayer if any
          if (Test-Path "PlayTorrioPlayer") {
            Remove-Item PlayTorrioPlayer -Recurse -Force
          }
          New-Item -ItemType Directory -Path PlayTorrioPlayer -Force
          
          # Download Windows version from V2
          $url = "https://github.com/ayman708-UX/PlayTorrioPlayerV2/releases/download/v1.8.65/PlayTorrio-Windows-x64.zip"
          $zipPath = "PlayTorrioPlayer\player.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          
          # Extract directly to PlayTorrioPlayer folder
          Expand-Archive -Path $zipPath -DestinationPath PlayTorrioPlayer -Force
          Remove-Item $zipPath -Force
          
          # Check if exe is in root or nested folder (check both PlayTorrio.exe and PlayTorrioPlayer.exe)
          $exeInRoot = (Test-Path "PlayTorrioPlayer\PlayTorrio.exe") -or (Test-Path "PlayTorrioPlayer\PlayTorrioPlayer.exe")
          $nestedFolder = Get-ChildItem -Path PlayTorrioPlayer -Directory | Where-Object { 
            (Test-Path "$($_.FullName)\PlayTorrio.exe") -or (Test-Path "$($_.FullName)\PlayTorrioPlayer.exe")
          } | Select-Object -First 1
          
          if ($exeInRoot) {
            Write-Host "✓ Player exe found in root"
          } elseif ($nestedFolder) {
            Write-Host "Found nested folder: $($nestedFolder.Name)"
            Write-Host "Flattening structure..."
            Get-ChildItem -Path $nestedFolder.FullName | Move-Item -Destination PlayTorrioPlayer -Force
            Remove-Item $nestedFolder.FullName -Recurse -Force
            Write-Host "✓ Structure flattened"
          } else {
            Write-Host "❌ Player exe NOT FOUND!"
            Write-Host "Directory contents:"
            Get-ChildItem PlayTorrioPlayer -Recurse | Select-Object FullName
            exit 1
          }
          
          # Final verification (check both names)
          if ((Test-Path "PlayTorrioPlayer\PlayTorrio.exe") -or (Test-Path "PlayTorrioPlayer\PlayTorrioPlayer.exe")) {
            Write-Host "✓ Player exe ready - App will be able to launch it"
            if (Test-Path "PlayTorrioPlayer\PlayTorrio.exe") {
              Write-Host "  Found: PlayTorrio.exe"
            }
            if (Test-Path "PlayTorrioPlayer\PlayTorrioPlayer.exe") {
              Write-Host "  Found: PlayTorrioPlayer.exe"
            }
          } else {
            Write-Host "❌ Final check failed!"
            exit 1
          }

      - name: Verify PlayTorrioPlayer can be found by app (Windows)
        run: |
          Write-Host "=== PlayTorrioPlayer Verification ==="
          Write-Host "Checking for player executable..."
          Write-Host ""
          
          $exePath = ""
          if (Test-Path "PlayTorrioPlayer\PlayTorrio.exe") {
            $exePath = "PlayTorrioPlayer\PlayTorrio.exe"
          } elseif (Test-Path "PlayTorrioPlayer\PlayTorrioPlayer.exe") {
            $exePath = "PlayTorrioPlayer\PlayTorrioPlayer.exe"
          }
          
          if ($exePath) {
            $fileInfo = Get-Item $exePath
            Write-Host "✓ FOUND: $exePath"
            Write-Host "  Size: $($fileInfo.Length / 1MB) MB"
            Write-Host "  Modified: $($fileInfo.LastWriteTime)"
            Write-Host ""
            Write-Host "✓ App will successfully find and launch PlayTorrioPlayer"
          } else {
            Write-Host "❌ NOT FOUND: No player executable found"
            Write-Host ""
            Write-Host "Contents of PlayTorrioPlayer folder:"
            Get-ChildItem PlayTorrioPlayer -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
            Write-Host ""
            Write-Host "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          }

      - name: Setup FFmpeg (Windows)
        run: node build/setup-ffmpeg.cjs win

      - run: npm run build -- --win --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Extract yt-dlp (Linux)
        run: |
          if [ -f linyt.zip ]; then
            unzip -q linyt.zip
            rm -f linyt.zip
          elif [ -f linyt.rar ]; then
            sudo apt-get update -y
            sudo apt-get install -y unar
            unar -o . linyt.rar
            rm -f linyt.rar
          fi

          # FLATTEN linyt/linyt -> linyt
          if [ -f linyt/linyt/yt-dlp_linux ]; then
            mv linyt/linyt/yt-dlp_linux linyt/yt-dlp_linux
            chmod +x linyt/yt-dlp_linux
            rm -rf linyt/linyt
          fi

      - name: Check yt-dlp (Linux)
        run: |
          if [ -f linyt/yt-dlp_linux ] || [ -f linyt/yt-dlp ]; then
            chmod +x linyt/yt-dlp* || true
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (Linux)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download Linux AppImage from V2
          curl -L -o PlayTorrioPlayer/NipaPlay-1.8.65-Linux-amd64.AppImage \
            "https://github.com/ayman708-UX/PlayTorrioPlayerV2/releases/download/v1.8.65/NipaPlay-1.8.65-Linux-amd64.AppImage"
          
          # Make AppImage executable
          chmod +x PlayTorrioPlayer/NipaPlay-1.8.65-Linux-amd64.AppImage
          
          # Verify AppImage exists
          if [ -f PlayTorrioPlayer/NipaPlay-1.8.65-Linux-amd64.AppImage ]; then
            echo "✓ PlayTorrioPlayer AppImage ready - App will be able to launch it"
            ls -la PlayTorrioPlayer/
          else
            echo "❌ PlayTorrioPlayer AppImage NOT FOUND!"
            echo "Directory contents:"
            find PlayTorrioPlayer -type f
            exit 1
          fi

      - name: Verify PlayTorrioPlayer can be found by app (Linux)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Checking for AppImage..."
          echo ""
          
          PLAYER="PlayTorrioPlayer/NipaPlay-1.8.65-Linux-amd64.AppImage"
          
          if [ -f "$PLAYER" ]; then
            echo "✓ FOUND: $PLAYER"
            echo "  Size: $(du -h "$PLAYER" | cut -f1)"
            echo "  Executable: $(test -x "$PLAYER" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
            exit 0
          else
            echo "❌ AppImage not found!"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            ls -laR PlayTorrioPlayer/
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (Linux)
        run: node build/setup-ffmpeg.cjs linux

      - run: npm run build -- --linux --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          # FLATTEN macyt/macyt -> macyt
          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS x64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (macOS)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download macOS Universal version from V2
          curl -L -o PlayTorrioPlayer/player.zip \
            "https://github.com/ayman708-UX/PlayTorrioPlayerV2/releases/download/v1.8.65/PlayTorrio-macOS-Universal.zip"
          
          # Extract
          cd PlayTorrioPlayer
          unzip -q player.zip
          rm -f player.zip
          
          # Check if .app is in root or nested folder
          APP_IN_ROOT=$(find . -maxdepth 1 -name "*.app" -type d | head -1)
          NESTED_FOLDER=$(find . -maxdepth 1 -type d ! -name "." ! -name "*.app" | head -1)
          
          if [ -n "$APP_IN_ROOT" ]; then
            echo "✓ .app found in root: $APP_IN_ROOT"
          elif [ -n "$NESTED_FOLDER" ]; then
            echo "Found nested folder: $NESTED_FOLDER"
            APP_NESTED=$(find "$NESTED_FOLDER" -maxdepth 1 -name "*.app" -type d | head -1)
            if [ -n "$APP_NESTED" ]; then
              echo "Flattening structure..."
              mv "$NESTED_FOLDER"/* . 2>/dev/null || true
              rm -rf "$NESTED_FOLDER"
              echo "✓ Structure flattened"
            fi
          fi
          
          # Set executable permissions for the app binary
          if [ -f "NipaPlay.app/Contents/MacOS/NipaPlay" ]; then
            chmod +x "NipaPlay.app/Contents/MacOS/NipaPlay"
            echo "✓ NipaPlay.app ready (V2)"
          elif [ -f "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            chmod +x "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
            echo "✓ PlayTorrioPlayer.app ready (V1)"
          else
            echo "⚠ Player app not found, listing contents:"
            find . -type f | head -20
          fi
          cd ..

      - name: Verify PlayTorrioPlayer can be found by app (macOS x64)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Checking for player app..."
          echo ""
          
          PLAYER_PATH=""
          if [ -f "PlayTorrioPlayer/NipaPlay.app/Contents/MacOS/NipaPlay" ]; then
            PLAYER_PATH="PlayTorrioPlayer/NipaPlay.app/Contents/MacOS/NipaPlay"
          elif [ -f "PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            PLAYER_PATH="PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          fi
          
          if [ -n "$PLAYER_PATH" ]; then
            echo "✓ FOUND: $PLAYER_PATH"
            echo "  Size: $(du -h "$PLAYER_PATH" | cut -f1)"
            echo "  Executable: $(test -x "$PLAYER_PATH" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
          else
            echo "❌ NOT FOUND: No player app found"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            find PlayTorrioPlayer -type f | head -20
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (macOS)
        run: node build/setup-ffmpeg.cjs mac

      - run: npm run build -- --mac --x64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS arm64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (macOS)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download macOS Universal version from V2
          curl -L -o PlayTorrioPlayer/player.zip \
            "https://github.com/ayman708-UX/PlayTorrioPlayerV2/releases/download/v1.8.65/PlayTorrio-macOS-Universal.zip"
          
          # Extract
          cd PlayTorrioPlayer
          unzip -q player.zip
          rm -f player.zip
          
          # Check if .app is in root or nested folder
          APP_IN_ROOT=$(find . -maxdepth 1 -name "*.app" -type d | head -1)
          NESTED_FOLDER=$(find . -maxdepth 1 -type d ! -name "." ! -name "*.app" | head -1)
          
          if [ -n "$APP_IN_ROOT" ]; then
            echo "✓ .app found in root: $APP_IN_ROOT"
          elif [ -n "$NESTED_FOLDER" ]; then
            echo "Found nested folder: $NESTED_FOLDER"
            APP_NESTED=$(find "$NESTED_FOLDER" -maxdepth 1 -name "*.app" -type d | head -1)
            if [ -n "$APP_NESTED" ]; then
              echo "Flattening structure..."
              mv "$NESTED_FOLDER"/* . 2>/dev/null || true
              rm -rf "$NESTED_FOLDER"
              echo "✓ Structure flattened"
            fi
          fi
          
          # Set executable permissions for the app binary
          if [ -f "NipaPlay.app/Contents/MacOS/NipaPlay" ]; then
            chmod +x "NipaPlay.app/Contents/MacOS/NipaPlay"
            echo "✓ NipaPlay.app ready (V2)"
          elif [ -f "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            chmod +x "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
            echo "✓ PlayTorrioPlayer.app ready (V1)"
          else
            echo "⚠ Player app not found, listing contents:"
            find . -type f | head -20
          fi
          cd ..

      - name: Verify PlayTorrioPlayer can be found by app (macOS arm64)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Checking for player app..."
          echo ""
          
          PLAYER_PATH=""
          if [ -f "PlayTorrioPlayer/NipaPlay.app/Contents/MacOS/NipaPlay" ]; then
            PLAYER_PATH="PlayTorrioPlayer/NipaPlay.app/Contents/MacOS/NipaPlay"
          elif [ -f "PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            PLAYER_PATH="PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          fi
          
          if [ -n "$PLAYER_PATH" ]; then
            echo "✓ FOUND: $PLAYER_PATH"
            echo "  Size: $(du -h "$PLAYER_PATH" | cut -f1)"
            echo "  Executable: $(test -x "$PLAYER_PATH" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
          else
            echo "❌ NOT FOUND: No player app found"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            find PlayTorrioPlayer -type f | head -20
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (macOS)
        run: node build/setup-ffmpeg.cjs mac

      - run: npm run build -- --mac --arm64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
  finalize-release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-linux
      - build-macos-x64
      - build-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: ver
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: Ensure tag uses v prefix
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          echo "Using tag: $TAG"

      - name: Update GitHub Release (title + notes, keep draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          generate_release_notes: true
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
